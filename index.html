<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>TORNEO DI BILIARDINO</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f1f5e3; margin: 0; padding: 0; }
    header { background-color: #0e7546; color: white; text-align: center; padding: 1.5rem 0; font-family: 'Bebas Neue', sans-serif; font-size: 4.5rem; letter-spacing: 2px; }
    .container { display: flex; flex-direction: column; gap: 20px; padding: 20px; max-width: 1200px; margin: auto; }
    #matches-container, .standings { flex: 1; background: #fff; border-radius: 8px; padding: 15px; overflow-y: auto; }
    .standings h2, #matches-container h2 { text-align: center; text-transform: uppercase; }
    .match { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 10px 15px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; transition: background 0.3s; flex-wrap: wrap; }
    .match.played { background: #d2f8d2; }
    .match.played .player-names { color: #555; }
    .hidden { display: none !important; }
    .score-input { width: 3rem; text-align: center; font-size: 1rem; }
    .score-section { display: flex; align-items: center; gap: 5px; flex-grow: 1; justify-content: flex-end; }
    .filter-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; justify-content: center; margin-bottom: 30px; }
    .filter-btn { padding: 5px 10px; background: #ccc; border: none; border-radius: 5px; cursor: pointer; }
    .filter-btn.active { background: #a3d9a5; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #e7f5e7; color: #0e7546; }
    .submit-btn, .edit-btn, #reset-button { background: #0e7546; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .edit-btn { background-color: #66bb6a; }
    #reset-button { display: block; margin: 20px auto 10px; padding: 8px 15px; font-size: 0.8rem; background-color: #dc3545;}
    .gold { background-color: #fff8dc !important; }
    .silver { background-color: #f5f5f5 !important; }
    .bronze { background-color: #fcebd0 !important; }
    .draw-button { background-color: #0e7546; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    .draw-button:hover { background-color: #0c633a; }
    .team-color-indicator { display: inline-block; width: 15px; height: 15px; border-radius: 50%; background-color: black; margin-right: 5px; vertical-align: middle; transition: background-color 0.1s ease-in-out; }
    .team-color-indicator.final-blue { background-color: blue !important; }
    .team-color-indicator.final-red { background-color: red !important; }
    .player-names-section { display: flex; align-items: center; gap: 5px; flex-grow: 1; min-width: 200px; }
    .player-names { display: flex; align-items: center; gap: 5px; }
    .match.match-started .draw-button { display: none; }
    .match.match-started .player-names-section { justify-content: flex-start; }
    .match.match-started .player-names { flex-grow: 1; }
    @media (max-width: 600px) {
      header { font-size: 4rem; padding: 1.5rem 0; }
      h2 { font-size: 2rem; }
      .container { flex-direction: column; padding: 10px; }
      .match { flex-direction: column; align-items: stretch; padding: 20px 15px; }
      .player-names-section { width: 100%; justify-content: center; margin-bottom: 20px; font-size: 1.4rem; }
      .player-names { justify-content: center; flex-grow: 1; }
      .team-color-indicator { width: 25px; height: 25px; }
      .score-section { width: 100%; justify-content: center; margin-top: 20px; }
      .score-input { width: 4rem; font-size: 1.5rem; padding: 5px; }
      .submit-btn, .edit-btn { padding: 10px 15px; font-size: 1.1rem; }
      .draw-button { margin: 0 auto 20px auto; width: fit-content; padding: 12px 18px; font-size: 1.2rem; }
      .filter-buttons { justify-content: center; gap: 15px; }
      .filter-btn { padding: 10px 15px; font-size: 1.1rem; }
      table, th, td { font-size: 1rem; padding: 12px 10px; }
      #reset-button { padding: 12px 25px; font-size: 1.1rem; margin: 25px auto 15px; }
    }
  </style>
</head>
<body>
  <header>TORNEO DI BILIARDINO</header>

  <div class="container">
    <div class="standings">
      <h2>Classifica</h2>
      <table>
        <thead>
          <tr>
            <th>Posizione</th><th>Giocatore</th><th>Giocate</th><th>Vinte</th><th>% Vittorie</th><th>Segnati</th><th>Subiti</th>
          </tr>
        </thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>
    <div id="matches-container">
      <h2>Partite</h2>
      <div class="filter-buttons" id="player-and-status-filters"></div>
      <div id="matches"></div>
    </div>
  </div>
  <button id="reset-button" onclick="resetScores()">AZZERA PUNTEGGI TORNEO</button>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // 1. Inizializzazione di Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAYjQZxyYDYrxuzYdUtsQnSlKrNFuvwfyo",
        authDomain: "torneo-biliardino.firebaseapp.com",
        projectId: "torneo-biliardino",
        storageBucket: "torneo-biliardino.firebasestorage.app",
        messagingSenderId: "592520260738",
        appId: "1:592520260738:web:8496f057e057cee84d589b",
        measurementId: "G-B6CLT4K3GL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const scoresCollection = db.collection("scores");

    // 2. Variabili e costanti globali dell'applicazione
    let savedScores = {}; // Conterrà una copia locale dei dati da Firebase
    const players = ["CHIARA", "FRENKIE", "IRE", "KLM", "LUCA", "TEO"];
    let stats = Object.fromEntries(players.map(p => [p, { points: 0, played: 0, won: 0, goalsFor: 0, goalsAgainst: 0 }]));
    const matches = [
      ["CHIARA", "FRENKIE", "IRE", "KLM"], ["CHIARA", "FRENKIE", "IRE", "LUCA"], ["CHIARA", "FRENKIE", "IRE", "TEO"],
      ["CHIARA", "FRENKIE", "KLM", "LUCA"], ["CHIARA", "FRENKIE", "KLM", "TEO"], ["CHIARA", "FRENKIE", "LUCA", "TEO"],
      ["CHIARA", "IRE", "FRENKIE", "KLM"], ["CHIARA", "IRE", "FRENKIE", "LUCA"], ["CHIARA", "IRE", "FRENKIE", "TEO"],
      ["CHIARA", "IRE", "KLM", "LUCA"], ["CHIARA", "IRE", "KLM", "TEO"], ["CHIARA", "IRE", "LUCA", "TEO"],
      ["CHIARA", "KLM", "FRENKIE", "IRE"], ["CHIARA", "KLM", "FRENKIE", "LUCA"], ["CHIARA", "KLM", "FRENKIE", "TEO"],
      ["CHIARA", "KLM", "IRE", "LUCA"], ["CHIARA", "KLM", "IRE", "TEO"], ["CHIARA", "KLM", "LUCA", "TEO"],
      ["CHIARA", "LUCA", "FRENKIE", "IRE"], ["CHIARA", "LUCA", "FRENKIE", "KLM"], ["CHIARA", "LUCA", "FRENKIE", "TEO"],
      ["CHIARA", "LUCA", "IRE", "KLM"], ["CHIARA", "LUCA", "IRE", "TEO"], ["CHIARA", "LUCA", "KLM", "TEO"],
      ["CHIARA", "TEO", "FRENKIE", "IRE"], ["CHIARA", "TEO", "FRENKIE", "KLM"], ["CHIARA", "TEO", "FRENKIE", "LUCA"],
      ["CHIARA", "TEO", "IRE", "KLM"], ["CHIARA", "TEO", "IRE", "LUCA"], ["CHIARA", "TEO", "KLM", "LUCA"],
      ["FRENKIE", "IRE", "KLM", "LUCA"], ["FRENKIE", "IRE", "KLM", "TEO"], ["FRENKIE", "IRE", "LUCA", "TEO"],
      ["FRENKIE", "KLM", "IRE", "LUCA"], ["FRENKIE", "KLM", "IRE", "TEO"], ["FRENKIE", "KLM", "LUCA", "TEO"],
      ["FRENKIE", "LUCA", "IRE", "KLM"], ["FRENKIE", "LUCA", "IRE", "TEO"], ["FRENKIE", "LUCA", "KLM", "TEO"],
      ["FRENKIE", "TEO", "IRE", "KLM"], ["FRENKIE", "TEO", "IRE", "LUCA"], ["FRENKIE", "TEO", "KLM", "LUCA"],
      ["IRE", "KLM", "LUCA", "TEO"], ["IRE", "LUCA", "KLM", "TEO"], ["IRE", "TEO", "KLM", "LUCA"]
    ].map(([a1, a2, b1, b2]) => [[a1, a2], [b1, b2]]);
    const activePlayerFilters = new Set();
    let currentMatchStatusFilter = 'all';

    // 3. Funzioni dell'applicazione
    function renderFilters() {
      const filterContainer = document.getElementById("player-and-status-filters");
      filterContainer.innerHTML = "";
      players.forEach(p => {
        const btn = document.createElement("button");
        btn.textContent = p; btn.className = "filter-btn";
        if (activePlayerFilters.has(p)) btn.classList.add('active');
        btn.onclick = () => { btn.classList.toggle("active"); activePlayerFilters.has(p) ? activePlayerFilters.delete(p) : activePlayerFilters.add(p); filterMatches(); };
        filterContainer.appendChild(btn);
      });
      const statusFilters = [{ text: "TUTTE", value: "all" }, { text: "GIOCATE", value: "played" }, { text: "DA GIOCARE", value: "unplayed" }];
      statusFilters.forEach(filter => {
        const btn = document.createElement("button");
        btn.textContent = filter.text; btn.className = "filter-btn";
        if (currentMatchStatusFilter === filter.value) btn.classList.add('active');
        btn.onclick = () => { currentMatchStatusFilter = filter.value; renderFilters(); filterMatches(); };
        filterContainer.appendChild(btn);
      });
    }

    function renderMatches() {
      const c = document.getElementById("matches");
      c.innerHTML = "";
      matches.forEach(([e, t], l) => {
        const s = document.createElement("div"); s.className = "match";
        const a = savedScores[l];
        const isPlayed = a && (a.s1 !== undefined && a.s2 !== undefined) && (a.s1 !== 0 || a.s2 !== 0);
        if (isPlayed || (a && a.team1Color)) s.classList.add("match-started");
        if (isPlayed) s.classList.add("played");
        const team1FinalColorClass = a?.team1Color || '';
        const team2FinalColorClass = a?.team2Color || '';
        s.innerHTML = `
          <div class="player-names-section">
            <button class="draw-button" onclick="startMatchDraw(${l})">Inizia Partita</button>
            <div class="player-names">
              <span id="team1-indicator-${l}" class="team-color-indicator ${team1FinalColorClass}"></span> ${e.join(" & ")} vs
              <span id="team2-indicator-${l}" class="team-color-indicator ${team2FinalColorClass}"></span> ${t.join(" & ")}
            </div>
          </div>
          <div class="score-section">
            <input type="number" id="s1-${l}" class="score-input" min="0" max="10" value="${a?.s1 !== undefined ? a.s1 : ""}" ${a && a.s1 !== undefined ? "disabled" : ""}>
            -
            <input type="number" id="s2-${l}" class="score-input" min="0" max="10" value="${a?.s2 !== undefined ? a.s2 : ""}" ${a && a.s2 !== undefined ? "disabled" : ""}>
            <button id="submit-btn-${l}" class="submit-btn" onclick="submitScore(${l})" style="display: ${a && a.s1 !== undefined ? "none" : "inline-block"};">OK</button>
            <button id="edit-btn-${l}" class="edit-btn" onclick="editScore(${l})" style="display: ${a && a.s1 !== undefined ? "inline-block" : "none"};">Modifica</button>
          </div>
        `;
        c.appendChild(s);
      });
    }

    function editScore(c) {
      document.getElementById(`s1-${c}`).disabled = false;
      document.getElementById(`s2-${c}`).disabled = false;
      document.getElementById(`submit-btn-${c}`).style.display = "inline-block";
      document.getElementById(`edit-btn-${c}`).style.display = "none";
    }

    async function submitScore(c) {
      const e = document.getElementById(`s1-${c}`);
      const t = document.getElementById(`s2-${c}`);
      const l = parseInt(e.value);
      const s = parseInt(t.value);
      if (!isNaN(l) && !isNaN(s)) {
        if (l === 0 && s === 0) {
          if (confirm("Sei sicuro di voler resettare il punteggio a 0-0? Questo lo rimuoverà dalle partite giocate.")) {
            await scoresCollection.doc(String(c)).delete();
          } else {
            e.value = savedScores[c]?.s1 || "";
            t.value = savedScores[c]?.s2 || "";
          }
        } else {
          const scoreData = { s1: l, s2: s };
          if (savedScores[c]?.team1Color) scoreData.team1Color = savedScores[c].team1Color;
          if (savedScores[c]?.team2Color) scoreData.team2Color = savedScores[c].team2Color;
          await scoresCollection.doc(String(c)).set(scoreData, { merge: true });
        }
      }
    }

    function calculateAllStats() {
      stats = Object.fromEntries(players.map(p => [p, { played: 0, won: 0, goalsFor: 0, goalsAgainst: 0 }]));
      Object.entries(savedScores).forEach(([matchIndex, scoreData]) => {
          const [team1, team2] = matches[parseInt(matchIndex, 10)];
          const score1 = scoreData.s1;
          const score2 = scoreData.s2;
          if ((score1 !== undefined && score2 !== undefined) && (score1 !== 0 || score2 !== 0)) {
              team1.forEach(p => { stats[p].played++; stats[p].goalsFor += score1; stats[p].goalsAgainst += score2; });
              team2.forEach(p => { stats[p].played++; stats[p].goalsFor += score2; stats[p].goalsAgainst += score1; });
              if (score1 > score2) team1.forEach(p => stats[p].won++);
              else if (score2 > score1) team2.forEach(p => stats[p].won++);
          }
      });
      updateLeaderboard();
    }

    function updateLeaderboard() {
      const c = document.getElementById("leaderboard"); c.innerHTML = "";
      const sortedPlayers = Object.entries(stats).sort(([, a], [, b]) => (b.won / b.played || 0) - (a.won / a.played || 0) || b.won - a.won || (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst));
      sortedPlayers.forEach(([e, t], l) => {
        const s = t.played > 0 ? Math.round(t.won / t.played * 100) + "%" : "0%";
        const a = document.createElement("tr");
        if (l === 0) a.classList.add("gold"); else if (l === 1) a.classList.add("silver"); else if (l === 2) a.classList.add("bronze");
        a.innerHTML = `<td>${l + 1}</td><td><strong>${e}</strong></td><td>${t.played}</td><td>${t.won}</td><td>${s}</td><td><strong>${t.goalsFor}</strong></td><td>${t.goalsAgainst}</td>`;
        c.appendChild(a);
      });
    }

    function filterMatches() {
      document.querySelectorAll("#matches .match").forEach((matchElement, index) => {
        const [team1, team2] = matches[index];
        const allPlayers = [...team1, ...team2];
        const score = savedScores[index];
        const isPlayed = score && (score.s1 !== undefined && score.s2 !== undefined) && (score.s1 !== 0 || score.s2 !== 0);
        const playerFilterOk = activePlayerFilters.size === 0 || [...activePlayerFilters].every(p => allPlayers.includes(p));
        const statusFilterOk = currentMatchStatusFilter === 'all' || (currentMatchStatusFilter === 'played' && isPlayed) || (currentMatchStatusFilter === 'unplayed' && !isPlayed);
        matchElement.style.display = (playerFilterOk && statusFilterOk) ? "" : "none";
      });
    }

    async function resetScores() {
      if (confirm("Sei SICURO di voler azzerare TUTTI i punteggi dell'intero torneo? Questa azione è IRREVERSIBILE.")) {
        alert("Cancellazione in corso... Potrebbe richiedere qualche secondo.");
        const snapshot = await scoresCollection.get();
        const batch = db.batch();
        snapshot.forEach(doc => { batch.delete(doc.ref); });
        await batch.commit();
        alert("Torneo azzerato!");
      }
    }

    let animationInterval;
    function startMatchDraw(matchIndex) {
      if (animationInterval) clearInterval(animationInterval);
      const team1Indicator = document.getElementById(`team1-indicator-${matchIndex}`);
      const team2Indicator = document.getElementById(`team2-indicator-${matchIndex}`);
      let isRedForTeam1 = true; let animationCount = 0; const totalFlashes = 10;
      animationInterval = setInterval(() => {
        if (animationCount < totalFlashes) {
          team1Indicator.style.backgroundColor = isRedForTeam1 ? 'red' : 'blue';
          team2Indicator.style.backgroundColor = isRedForTeam1 ? 'blue' : 'red';
          isRedForTeam1 = !isRedForTeam1; animationCount++;
        } else {
          clearInterval(animationInterval);
          determineStartingTeam(matchIndex);
        }
      }, 100);
    }

    async function determineStartingTeam(matchIndex) {
      const team1Indicator = document.getElementById(`team1-indicator-${matchIndex}`);
      const team2Indicator = document.getElementById(`team2-indicator-${matchIndex}`);
      let team1Color = (Math.random() < 0.5) ? 'blue' : 'red';
      let team2Color = (team1Color === 'blue') ? 'red' : 'blue';
      team1Indicator.className = `team-color-indicator final-${team1Color}`;
      team2Indicator.className = `team-color-indicator final-${team2Color}`;
      await scoresCollection.doc(String(matchIndex)).set({
        team1Color: `final-${team1Color}`,
        team2Color: `final-${team2Color}`
      }, { merge: true });
    }

    // 4. Listener di Firebase (si attiva al caricamento e a ogni modifica)
    scoresCollection.onSnapshot(snapshot => {
        console.log("Dati aggiornati ricevuti da Firebase!");
        const newScores = {};
        snapshot.forEach(doc => {
            newScores[doc.id] = doc.data();
        });
        savedScores = newScores;
        // Ad ogni aggiornamento, ridisegna tutta la UI con i dati freschi
        renderFilters();
        renderMatches();
        calculateAllStats();
        filterMatches();
    });

  </script>
</body>
</html>
